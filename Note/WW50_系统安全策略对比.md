# 安全隔离

### TrustZone 隔离

- S，NSC，NS分区
- IDAU+SAU
- 区域编号
![image.png|500|600](https://pic.lllincx.cn/20251201145836648.png)

- 安全应用可以发起安全事务和非安全事务
- 非安全应用只能发起非安全事务
- 安全事务只能访问安全存储器和资源
- 安全事务只能使用安全区域地址发起
- 非安全事务只能访问非安全存储器和资源
- 非安全事务只能使用非安全区域地址发起。

### 特权域隔离

系统和应用分为特权域和非特权域。CPU 可通过以特权或非特权模式执行代码来限制或排除对某些资源的访问

- 特权模式可以访问特权和非特权域
- 非特权模式只能访问非特权域

### 其他主机安全隔离

#### RENESAS RA8P1

通过主机安全归属单元（MSAU）实现。
MSAU 是用于定义除 CPU 以外的主设备 (Master) 的系统特定安全地址映射的 IDAU。
MSAU 不定义非安全可调用 (NSC) 和区域编号。
由 MSAU 定义的安全映射固定在硬件中，无法通过软件更改。

#### STM32U5

通过GTZC（全局TrustZone控制）实现。保护传统存储器和外设免受来自 Cortex-M33 之外的其他主器件的非安全事务的影响。
![image.png|600](https://pic.lllincx.cn/20251211135441629.png)
TZSC：TrustZone 安全控制器，保护外设

MPCBB：基于块的存储器保护控制器
可以配置嵌入式 SRAM 块的安全性和特权

TZIC：TrustZone 非法访问控制器
GTZC 中的 TZIC 块收集源自受 GTZC 或 TrustZone 感知外设保护的源的所有非法访问事件，产生一个针对 NVIC 的全局安全中断。

![image.png|600](https://pic.lllincx.cn/20251211140058862.png)

#### STM32N6

|**组件**|**位置**|**核心功能**|**关键特性 (新补充)**|
|---|---|---|---|
|**RIMU**|总线发起端 (Masters)|**身份定义者**：决定发起访问时携带什么“属性” (Security, Privilege, CID)。|位于 AXI 总线发起端，负责给 DMA 等“哑巴”设备贴标签。|
|**RISUP**|外设总线目标端 (Peripherals)|**外设防火墙**：决定哪个安全/特权级别能访问该外设。|**集中式配置**：由 RIFSC 统一管理配置寄存器。|
|**RISAF**|内存目标端 (Memories)|**内存防火墙**：决定内存区域的访问权限。|**分布式配置**：拥有**本地 (Self-contained)** 配置寄存器，不由 RIFSC 直接统管，适合灵活划分内存区域。|
|**RIFSC**|中心控制器|**配置中心**：包含所有 RIMU 和 RISUP 的配置寄存器。|决定通用的 RIF 参数。|
|**IAC**|中断访问控制器|**违规上报者**：收集所有防火墙的违规事件，向 CPU 汇报。|**256 个中断源**：RISUP (0-127), RIF-aware 外设 & RISAF (128+)。|
# 生命周期

## RENESAS RA8P1

器件生命周期管理（DLM）用于识别器件当前的开发、生产或部署阶段，并控制调试功能、串行编程接口以及 Renesas 测试模式的能力。

| **生命周期状态 (Lifecycle)** | **定义 (Definition)**                               | **保护级别 (Protection level)** | **调试功能 (Debug function)** | **串行编程 (Serial programming)**            | **瑞萨测试模式 (Renesas test mode)** |
| ---------------------------- | --------------------------------------------------- | ------------------------------- | ----------------------------- | -------------------------------------------- | ------------------------------------ |
| **OEM**                      | **原始设备制造商**                                  | PL2 或 PL1 或 PL0               | 取决于认证级别                | 取决于认证级别                               | 不可用                               |
| **LCK_BOOT**                 | 锁定启动接口。调试接口和串行编程接口被永久禁用。    | PL0                             | 不可用                        | 不可用                                       | 不可用                               |
| **RMA_REQ**                  | 退料授权请求。 客户必须在此状态下将设备发送给瑞萨。 | PL0                             | 不可用                        | 可用<br>_(无法访问代码 MRAM/SiP Flash 区域)_ | 不可用                               |
| **RMA_ACK**                  | 退料授权已确认 。瑞萨进行故障分析。                 | PL2                             | 在安全和非安全调试中可用      | 可用<br>_(无法访问代码 MRAM/SiP Flash 区域)_ | 可用                                 |
| **RMA_RET**                  | 退料授权返回. <br>设备已返回给客户。设备无法启动。  | PL0                             | 不可用                        | 不可用                                       | 不可用                               |

![image.png|600|600](https://pic.lllincx.cn/20251201162432665.png)

### 更改生命周期状态 (Changing the Lifecycle State)

使用引导固件命令 (boot firmware commands) 来更改设备生命周期状态。
生命周期状态无法通过应用程序更新，但可以通过 `DLMMON` 寄存器读取当前的生命周期状态。
每次状态转换都是单向的，状态不可回退 (regressed)

#### 分支一：产品部署路径 (OEM $\rightarrow$ LCK_BOOT)

- 在 AL2 或 AL1 中使用参数设置命令可**禁止**转换到 LCK_BOOT
- 调试接口和串行编程接口永久禁用

#### 分支二：故障分析路径 (RMA 流程)

这是当芯片出现问题，需要寄回瑞萨（Renesas）进行分析时的流程。这是一个多阶段的单向链条。

**第一步：OEM 发起退料授权请求 (OEM $\rightarrow$ RMA_REQ)**
- **转换前提**：需要使用 **RMA_KEY** 进行密钥认证，该密钥必须由客户在 AL2 状态下预先注入。RMA_KEY 的密钥长度为 128 位。
- **内容擦除**：转换到 RMA_REQ 状态时，除以下内容外， MRAM 和 SiP Flash 中内容将被擦除。（在故障分析时，Renesas 可以读取永久锁定的块或寄存器的内容)。
  - 通过配置 `PBPS`/`PBPS_SEC` 寄存器永久锁定的 MRAM 块。
  - 通过配置 `POFSPS` 寄存器永久锁定的选项设置存储器。
- **禁用方法**：如果 **AL2_KEY** 被禁用，则无法转换到 RMA_REQ。
- **生效方法**：将器件生命周期状态更改为 RMA_REQ 后，MCU 不会立即响应。要继续使用启动固件命令，必须在复位后再次进入启动模式.

**第二步：瑞萨接收与分析 (RMA_REQ $\rightarrow$ RMA_ACK)**
- **转换前提**：需要瑞萨专用的密钥 (`RMA_ACK_KEY`) 进行认证。
- （安全和非安全）调试功能开启，进行故障分析。

**第三步：退回 OEM (RMA_ACK $\rightarrow$ RMA_RET)**
设备被寄回给 OEM。设备无法启动，生命周期结束。

#### 密钥认证方法

密钥认证采用“质询与响应” (Challenge and Response) 认证方式，或使用 MCU 唯一 ID 进行认证。响应值（用于质询与响应认证）或认证码（使用 MCU 唯一 ID）的计算方法如下：

$$\text{Response} = \text{AES-128 CMAC} (\text{RMA\_KEY}, \text{128-bit challenge})$$
$$\text{Authentication code} = \text{AES-128 CMAC} (\text{RMA\_KEY}, \text{128-bit MCU unique ID})$$
### 保护级别和认证级别 (Protection and Authentication Level)

- 保护等级 (PL) 和认证等级 (AL) 决定了调试功能和串行编程接口的可用性。
- 仅 OEM 生命周期状态下，才可以更改 PL 和 AL。
- AL 表示一种临时的认证状态，并在 MCU 上电复位后初始化为 PL。PL 和 AL 仅能由启动固件 (Boot Firmware) 修改，应用程序无法对其进行更改。
  ![image.png|600|600](https://pic.lllincx.cn/20251203103630337.png)

| **认证级别 (AL)** | **调试功能**                                                       | **串行编程接口**                                                        |
| ----------------- | ------------------------------------------------------------------ | ----------------------------------------------------------------------- |
| **AL2**           | 非安全和安全调试功能均已启用，且调试器可访问。                     | 所有功能均可用。                                                        |
| **AL1**           | 仅启用非安全调试功能，调试器仅可访问定义的“非安全调试可访问区域”。 | 可用，但**无法**对安全代码 MRAM 或 SiP Flash 区域进行编程、擦除或读取。 |
| **AL0**           | 无可用调试功能。                                                   | 可用，但**无法**访问代码 MRAM 或 SiP Flash 区域。                       |

#### 修改保护等级 (PL)

- 降级：无任何限制。
- 升级：要求 MCU 当前必须处于与目标 PL 对应的 AL 等级。例如：若当前处于 AL1，则可设为 PL1，但无法设为 PL2。
- 初始化：重置 PL，恢复为 PL2，同时 MRAM 和 SiP Flash 中的内容将被擦除。

#### 修改认证登记（AL）

- 降级：无任何限制。
- 升级：使用相应的 `AL2_KEY` 或 `AL1_KEY` 进行密钥认证。

初始化命令条件：选项设置存储器的 OTP 区域空，且 AL2_KEY 未禁用。
执行初始化命令后 MCU 不再响应。要继续使用串行编程命令，请在复位后重新进入 Boot 模式。

密钥（128 位）：
AL2_KEY：仅可在 AL2 状态下注入或禁用。
AL1_KEY：可在 AL2 或 AL1 状态下注入或禁用。

## STM32U5

| RDP保护等级 | 器件状态  | 调试能力 | 启动模式                                | 适用场景                  |
| ------- | ----- | ---- | ----------------------------------- | --------------------- |
| 0       | 器件打开  | 完全   | 可以从用户Flash、系统存储器（Bootloader）或SRAM启动 | 开发初期、芯片出厂             |
| 0.5     | 部分关闭  | 非安全  | 安全区域（安全用户或系统Flash）。不允许在 SRAM 中自举。   | 应用开发阶段，保护 Secure Boot |
| 1       | 存储器保护 | 受限   | 安全用户 Flash                          | 产品发布，允许最终用户重置         |
| 2       | 器件关闭  | 无    | （安全）用户 Flash                        | 高安全发布，支持返厂维修          |
回退方法
1 ->0：全片擦除，需要OEM key1
1 ->0.5：非安全数据擦除，需要OEM key2
2 ->1：不擦除，需要OEM key2

![image.png|600](https://pic.lllincx.cn/20251211143146622.png)
## STM32N6

| **BSEC 状态 (1)**       | **上部熔丝** | **SAES 中的 DHUK (2)** | **完全调试** | **BootROM 访问** | **熔丝编程** |
| ----------------------- | ------------ | ---------------------- | ------------ | ---------------- | ------------ |
| **BSEC-open** (开放)    | 不可访问 (3) | 不可使用               | 是 (4)       | 部分             | 启用         |
| **BSEC-closed** (关闭)  | 可访问       | 硬件唯一               | 否 (5)       | 完全 (6)         | 启用         |
| **BSEC-invalid** (无效) | 不可访问 (3) | 不可使用               | 否           | 部分             | 禁用         |

**表格注释：**

1. 定义于 `BSEC_SR` 寄存器的 `NVSTATE` 位域 (`0x16`: BSEC-open, `0x0D`: BSEC-closed)。
2. SAES 外设中的派生硬件唯一密钥使用来自 BSEC 的 RHUK 信息（参见 4.3.15 节）。
3. 无法通过任何手段（功能性或非功能性）读取或编程。
4. ST 工程模式也可用。
5. 信任根应用程序可以解锁调试功能，除非 WORD18 中的任何 `debug_lock` 位 (25/24/23/22) 已被烧录。如果熔丝字 124 的第 20 位被烧录，ST 工程模式将被硬件禁用。
6. Boot ROM 执行结束时，会向 `BSEC_UNMAPR` 写入 `0xB9D8 FF1F`，将 Boot ROM 访问权限恢复为部分访问。

BSEC Closing -> BSEC Opening
通过烧录某些位，并执行复位

BSEC Opening -> BSEC Closing
用户通过 JTAG 输入已编程的 128 位密码，并执行复位

BSEC-invalid
当状态既不是 BSEC-open 也不是 BSEC-closed（`NVSTATE` 不等于 `0x16` 或 `0x0D`）时，安全状态被视为无效，此时应用最保守的安全配置

# 安全启动

## RENESAS RA8P1

安全启动旨在验证位于应用程序可执行存储器起始位置的 OEM 引导加载程序（称为 OEM_BL）的完整性和真实性。
OEM_BL 的验证发生在两个时间点：**初始编程时**以及**每次执行前**。

### 编程时的验证

当使用引导固件 (Boot Firmware) 编程`OEM_BL`时，系统会对其进行验证。此过程使用两份证书：

**密钥证书 (Key Certificate)**
认证对象：`OEM_BL`验证密钥（ `OEM_BL_PK`，即`OEM_BL` 验证密钥对的公钥）
签名：由`OEM_BL`验证根密钥对的私钥（ `OEM_ROOT_SK`）签名
`OEM_ROOT_PK`的哈希值（SHA2-256）通过"52.5 安全密钥注入”作为信任根密钥注册到 MCU 中。

**代码证书 (Code Certificate)**
认证对象：`OEM_BL`
签名：由`OEM_BL`验证密钥对的私钥部分（`OEM_BL_SK`）签名

**摘要编程**
`OEM_BL` 验证成功后，会生成 `OEM_BL` 和代码证书的 HMAC 值（称为`OEM_BL_digest`）并将其编程到 MRAM 中
HMAC 密钥派生自 **HUK (硬件唯一密钥)**，因此每个 MCU 生成的 HMAC 值都是独一无二的

[[![image.png|600|600](https://pic.lllincx.cn/20251208111644655.png)]]

### 执行时的验证

在单芯片模式下，当 `FSBLCTRL0` 寄存器启用了 FSBL 时，复位后将执行片上 OTP 中的**不可变第一阶段引导加载程序 (FSBL)**。

验证逻辑由 `FSBLCTRL1` 寄存器配置：

- **Secure Boot 模式**：FSBL 生成 OEM_BL 和代码证书的 HMAC 值，并与预期的 HMAC 值进行比较。若一致，FSBL 跳转至 OEM_BL。
- **CRC Boot 模式**：FSBL 计算 OEM_BL 的 CRC 值，并与代码证书中的预期 CRC 值比较。若一致，FSBL 跳转至 OEM_BL。

### 代码证书地址管理

代码证书必须编程在 MRAM 中，其位置信息存储在 `SACC0n` 或 `SACC1n` 寄存器中：

- `SACC0n`：指定 `BTFLG = 1` 时的代码证书起始地址。
- `SACC1n`：指定 `BTFLG = 0` 时的代码证书起始地址。

SACC 寄存器 OTP（一次性可编程）且不可擦除，各有 4 个区域用于更新代码证书的起始地址。

- **读取规则**：FSBL 按 $n$ 值**从大到小**的顺序读取，使用第一个**非全 1** 的值作为有效地址。
- **写入规则**：因此，编程时应按 $n$ 值**从小到大**的顺序使用寄存器。

## STM32N6

在应用程序复位 (Reset) 后，Cortex-M55 始终从片上 ROM 的起始位置启动。该 ROM 代码用于验证并解密加载到内部存储器中的镜像，加载源可以是外部闪存，也可以通过 UART、USB、I2C、SPI、FDCAN 或 JTAG 下载。

启动流程由**熔丝 (Fuses)** 定义的生命周期状态决定。系统复位时，硬件读取熔丝状态，将设备分为两类：**BSEC-open (开放)** 或 **BSEC-closed (封闭)**。

分支 1：BSEC-open 状态

> 场景：设备制造初期，通过 RMA 流程退回分析

- 启动类型：非安全启动
- 调试功能：启用
- 机密访问（机密熔丝和 ROM 安全区域）：禁用

分支 2：BSEC-closed 状态

> 场景：设备交付给客户时的默认状态。

- 调试功能：禁用
- 启动类型：安全启动
- Boot ROM 查询额外的熔丝以确定精确的生命周期状态，进入以下分支

- 分支 2.1 ：`secure_boot` 熔丝未熔断 (开发阶段)
  - 分支 2.1.1： `DEV_BOOT` 引脚置位
    - 调试功能：启用
    - 机密访问：禁用
  - 分支 2.1.2： `DEV_BOOT` 引脚未置位
    - 执行策略：直接执行镜像 (不校验签名)
- 分支 2.2：`secure_boot` 熔丝已熔断 (量产安全阶段)
  - 调试功能：禁用
  - 启动类型：安全启动
  - 执行策略：仅执行签名与解密验证通过的镜像

STMicroelectronics 提供签名工具，允许客户创建经过签名和加密的启动镜像。该启动镜像有时被称为 **FSBL**（第一阶段引导加载程序）或 **uRoT**（可更新信任根固件）。

## STM32U5

![image.png|600](https://pic.lllincx.cn/20251211155027614.png)

### TrustZone 禁用

- 正常启动：Reset $\rightarrow$ 用户程序。
- 系统启动：Reset $\rightarrow$ Bootloader (位于只读系统 Flash)。

### TrustZone 启用

1. RSS (位于只读系统 Flash，非易失配置，HDP 保护)。
2. Secure Bootloader (位于用户 Flash 的基于水印的安全区，非易失配置，HDP 保护)。
3. Runtime 阶段 (位于用户 Flash 的以下区域，易失配置，无 HDP 保护)：

   - 基于水印的安全区
   - 安全页
   - 非安全页

Bootloader-NS (位于只读系统 Flash）被忽略

**基于水印的安全区域**
水印 (Watermark) 机制通过在选项字节 (Option Bytes) 中配置一个地址阈值，将 Flash 物理划分为低地址的安全区和高地址的非安全区。

**易失与非易失**
“易失/非易失”特指 “安全属性配置” (Security Attribute Configuration) 的生存周期，而非 \*\*“存储介质” 本身。

- 存储介质（Flash）：永远是 非易失 的。无论配置如何，里面的数据掉电都不丢。
- 安全属性（配置）：
  - Option Bytes 定义 = 非易失属性（掉电后，该页“是安全页”这个身份保留）。
  - Registers 定义 = 易失属性（复位后，该页“是安全页”这个身份丢失，变回默认）。

**安全隐藏保护（Secure Hide Protection，HDP）**
在一个 系统复位周期 (System Reset Cycle)内，只执行一次后，就不能被访问或执行。

# 安全调试

## RENESAS RA8P1 & STM32U5 安全调试见生命周期

## STM32N6

### 上电读取生命周期

系统上电后（无视复位状态），读取 fuse 确定设备状态

- **BSEC-Open (开放态)**：无保护。调试器可以直接连接。
- **BSEC-Closed (封闭态)**：默认安全状态。调试接口被锁定，需要通过认证流程才能开启。

### 配置调试访问寄存器

对于 BSEC-closed 的器件，配置`BSEC_DBGCR` 和 `BSEC_AP_UNLOCK` 内容。只能在 Boot ROM 完成后由安全特权代码写入一次。
`BSEC_DBGCR` 仅在上电时复位：它在热复位（warm resets）期间保持其值。调试器无需在系统复位时重复认证过程。

### 调试开启背景条件

#### 调试解锁寄存器配置

`BSEC_DBGCR`中的`DBG_UNLOCK` 位写入 `0xB4`
`BSEC_AP_UNLOCK` 中的`UNLOCK`位写入 `0xB4`
`BSEC_DBGCR`中的`DBG_AUTH_SEC`位决定调试为安全与否。

#### HDPL 级别

HDPL != 0：Boot ROM 阶段绝对禁止打开调试（防止提取 Boot ROM 秘密）。
HDPL >= `DBG_AUTH_TIL`：当前层级必须达到设定阈值。`

### 调试认证流程

可信根可以执行调试认证协议开启调试。协议基于非对称加密的质询-响应 (Challenge-Response)机制（随机令牌可以阻止重放攻击）。主机与设备通过 DBGMCU 邮箱 (Mailbox) 进行双向通信 (基于 JTAG/SWD)。

1. **请求**：器件上电时，主机在设备处于复位状时，发送“开启请求 (Open-Request)”。
2. **质询**：设备生成一个**随机 Token** (Challenge)，发送给主机。
3. **响应**：主机使用私钥对“Token + 调试证书”进行签名，发回设备。
4. **验证**：设备使用预置在 fuse 的 **OEM 公钥** 验证签名。
5. **授权**：验证通过后，证书内容决定了开启的调试是否为安全。

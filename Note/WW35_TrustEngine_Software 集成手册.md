# 第一章 简介

## 1.1 关于 IoT平台安全套件（B 类）
- **全称**：IoT Platform Security Suite（IoT平台安全套件）  
- **定位**：面向物联网的整体安全解决方案，为各类 IoT 设备提供绝密执行环境  
- **架构涵盖三部分**：  
  1. 设备端安全功能软件（如安全启动 Secure Boot）  
  2. 可综合 Verilog 的加密引擎  
  3. 云端设备管理服务（如 SaaS（云端软件服务））  
- **部署环境**：资源受限的 SoC，至少含一颗 Arm Cortex-M 系列 MCU，可配合其他处理器实现通信功能（如 NB-IoT/LoRa）  
- **支持架构**：基于 Armv8-M 的 CPU（如 Cortex-M33）  
- **设计目标**：在有限硬件资源和最小性能损耗的情况下满足安全需求  

---

## 1.2 特性
- 安全启动（Secure Boot）  
- 安全调试（Secure Debug）  
- 固件空中升级（Firmware Over-The-Air，FOTA）  
- 配置与密钥注入（Provisioning）  
- 可信执行环境（Trusted Execution Environment，TEE）  
- 安全连接（Secure Connection）  

---

## 1.3 架构基础模块

### 总览
- **硬件（Hardware）**  
  - ARMv8-M 架构 CPU  
  - TrustEngine-200  
  - Fuse/OTP  
  - Flash/NVM 等存储  

- **设备软件（Device software）**  
  - **制造阶段（Manufacturing Stage）**：Provisioning Agent  
  - **启动阶段（Boot Stage）**：Secure Boot Core、Secure Debug Agent、TRNG Agent、FOTA Update Agent、BootROM/Bootloader  
  - **运行阶段（Runtime）**：  
    - **NSPE**：Wakaama、FOTA Download Agent、Socket、libclient 等  
    - **SPE**：MbedTLS、Flash、SST、SPM 等  

- **主机工具（Host tools）**  
  - Provisioning Tool  
  - Secure Debug Tool  
  - TRNG Tool  
  - Secure Boot Tool  

- **云服务（Cloud service）**  
  - DM SaaS（设备管理服务）  
  - FOTA SaaS（固件空中升级服务）  

### 1.3.1 硬件（TrustEngine-200）
- 高安全保障：支持密钥梯、生命周期管理、真随机数发生器（TRNG）  
- 高性能与低功耗加解密：依靠内部密码学引擎  
- 降低软件复杂度：部分安全功能在硬件中实现，如 LCS 管理和 OTP 访问控制  

### 1.3.2 制造阶段安全
- 提供安全配置机制（Provisioning）以建立初始信任数据  
- 建立云服务与设备的安全通信通道  
- 初始化凭证（如运行时安全通道的预共享密钥）  
- 制造阶段烧录部分 Fuse/OTP 位，防止后续被篡改  

### 1.3.3 启动阶段安全
- 安全启动：仅允许运行原始设备制造商发布的官方镜像  
- 安全调试：带权限的调试功能启用机制  
- FOTA 更新：验证和安装 FOTA 升级包  

### 1.3.4 运行阶段安全
- 基于 Arm TrustZone，符合 Arm PSA Firmware Framework 的 TEE 解决方案  
- 运行阶段使用 FreeRTOS，包括：  
  - 安全连接：利用 TEE 与 mbed TLS 建立与 SaaS（云端软件服务）的加密连接  
  - Wakaama：LWM2M（CoAP）实现  
  - FOTA 下载代理：基于 Wakaama 接收 FOTA 升级包  

### 1.3.5 云服务
- 安全调试 SaaS（云端软件服务）  
- 配置 SaaS（云端软件服务）  
- 固件空中升级 SaaS（云端软件服务）  
- 基于微服务架构，以 Java 应用程序包形式发布，并提供 Docker 文件构建镜像  

---

## 1.4 硬件要求
- CPU 必须基于 Armv8-M 架构  
- SoC 必须包含集成安全启动功能的 BootROM  
- 至少 1024 位 Fuse/OTP  
- NVM 中需预留存储空间保存 FOTA 包和启动标志（大小取决于 FOTA 配置）  
- 硬件加密引擎（TrustEngine-200）  

> - 1024 位 Fuse/OTP 要求针对功能完整场景，实际生产可调整  
> - 各安全功能还有额外的硬件需求  

---

## 1.5 软件要求
- 硬件适配层（HAL）：提供与硬件相关的操作，如读写 NVM  
- 平台适配层（PAL）：提供与平台相关的操作，如堆内存分配和释放  
- 主机端开发环境：用于构建整体解决方案  

---

## 1.6 符合的标准
- **AES**：高级加密标准  
- **RSA**：公钥密码系统  
- **ECDSA**：椭圆曲线数字签名算法  
- **HASH**：哈希函数  
- **CoAP**：物联网专用传输协议  
- **HTTPS**：安全的超文本传输协议  
- **微服务**：高可维护、松耦合、可独立部署的服务架构  
- **UDP**：用户数据报协议  
- **DTLS**：基于 UDP 的安全通信协议  
- **JSON**：轻量级数据交换格式  
- **TRNG**：真随机数发生器  
- **NIST**：美国国家标准与技术研究院  

---

## 1.7 产品版本
- **r0p0**：首次发布  
- **r1p0**：新增 PUF 功能支持  
- **r1p1**：修复工程勘误；支持 CMAC/CCM/GCM  
- **r1p2**：修复工程勘误；支持精简加密驱动；支持安全启动细粒度配置  

# 第二章 功能介绍

## 2.1 配置（Provisioning）

配置是将安全凭证初始化到设备上的过程，必须在安全环境中进行，通常是在制造阶段的生产线上完成。  
该方案在安全环境中，从云服务器向设备安全传输并写入关键信息（如设备 ID、型号密钥、安全启动/安全调试公钥哈希），同时确保仅存在于设备端的最高机密（如设备根密钥）不被泄露。  

通常，配置过程涉及三方：  
1. **配置代理（Provisioning Agent）**：运行在设备端  
2. **配置工具（Provisioning Tool）**：运行在主机端  
3. **配置 SaaS（云端软件服务）**

**配图解析**  
- **配置代理** 位于每台设备中，是执行配置任务的核心组件，多台带有配置代理的设备连接到 **配置工具**，信息由配置工具单向下发至设备端的配置代理。  
- **配置工具** 作为中间节点，一端通过单向通道向设备端配置代理下发数据，另一端通过 **HTTPS** 与 **配置 SaaS（云端软件服务）** 建立双向安全连接，实现与云端的数据交互。  
- 整个“设备—配置工具”组合及其通信过程均位于 **生产线环境** 内部，以确保数据交换全过程处于受控安全范围中。  

---

### 2.1.1 配置流程（Provisioning flow）
A. 配置工具中的一个内部线程向 **配置 SaaS（云端软件服务）** 请求所需数据。  
B. 请求到的数据被保存到本地存储。  
C. 配置工具从本地存储中获取部分配置信息。  
D. 将配置信息传输到设备端。  
E. 设备端的 **配置代理** 接收并使用这些数据执行配置操作。  
F. 配置代理生成结果数据并返回给配置工具。  
G. 配置工具将结果数据保存到本地存储。  
H. 另一个内部线程从本地存储中收集结果数据并上传至 **配置 SaaS（云端软件服务）**。  
I. **配置 SaaS（云端软件服务）** 将结果数据保存到数据库中。  

---

### 2.1.2 关键组件（Key components）

**配置代理（Provisioning Agent）**  
- 在制造阶段运行于设备端，从配置工具接收配置材料并写入 Fuse/OTP。  
- 配置完成后，收集配置结果并上报给配置工具。  
- 与配置工具的通信通道为 **具体实现定义（IMPLEMENTATION DEFINED）**。  
- 负责生成部分设备自维护的机密数据，例如仅加密引擎可访问的设备根密钥。  

**配置工具（Provisioning Tool）**  
- 连接设备与配置 SaaS 的纽带，运行在生产线 PC 工作站。  
- 功能：  
  - 通过 HTTPS 与配置 SaaS 建立安全连接  
  - 从 SaaS 获取配置材料并保存到本地存储  
  - 将配置材料发送到设备  
  - 接收设备的配置结果并保存到本地存储  
  - 将结果上报给 SaaS  
- IoT平台安全套件（B 类）提供支持这些功能的静态库，需要与其他具体实现逻辑（如与设备建立通道）链接，生成完整工具。  
- Arm China 提供参考实现。  
- 特性：  
  - **本地存储**：缓存材料与结果，提升效率并减少网络依赖。  
  - **双向认证连接**：SaaS 验证工具证书，工具验证 SaaS CA，确保双方合法性。  

**配置 SaaS（Provisioning SaaS）**  
- 管理不同产品的配置材料与结果。  
- 详情见《配置 SaaS 集成手册》。  
## 2.2 安全启动（Secure boot）

安全启动功能确保设备镜像的 **真实性**、**完整性** 和可选的 **机密性**。  
它在设备启动阶段验证设备镜像，并选择合适的启动路径。  
该安全启动方案采用轻量级加密算法、紧凑的数据结构和简化的验证流程，适配资源受限的 IoT 设备。  

> **注意**  
> - 扩展程序为可选。  
> - 镜像加密为可选。  

安全启动包含两个基本组件：  
- 安全启动工具（Secure boot tool）  
- 安全启动核心（Secure boot core）  
安全启动工具运行在主机端，用于生成清单文件（Manifest）。它通过两个 JSON 格式的描述文件收集所有必要的配置信息，例如设备镜像、非对称密钥文件以及可选的扩展程序。随后生成供安全启动核心使用的清单文件，并生成非对称公钥的哈希文件作为验证根。如果启用了镜像加密，还会生成加密后的镜像文件。

安全启动核心运行在设备端，是主要的安全启动逻辑。它提供清单验证、镜像验证以及可选的扩展程序运行功能。

清单文件（Manifest）是安全启动工具的输出，同时是安全启动核心的输入。它是一种信息载体，包含用于验证设备镜像的数据。

---

### 2.2.1 基本工作流程（Basic workflow）

在完整功能的安全启动中，基本流程如下：  
- 在主机侧，安全启动工具生成清单文件和加密的镜像文件。  
- 在设备侧，安全启动核心验证公钥、清单文件和设备镜像，并运行扩展程序。  

---

### 2.2.2 关键组件（Key components）

#### 安全启动工具（Secure boot tool）

安全启动工具是运行在主机侧的工具，用于生成清单文件。当前仅支持 **Linux ELF 64-bit 格式**。  

其需要两个配置文件：  
- **密钥描述文件（Key descriptor）**：包含与密钥相关的信息，例如签名密钥、签名算法、镜像摘要函数和镜像加密相关配置。  
- **清单描述文件（Manifest descriptor）**：包含与安全启动核心相关的配置及设备镜像信息，例如清单版本、安全启动使能标志、镜像静态地址、扩展程序文件等。  

安全启动工具的功能：  
- 解析配置文件并生成清单文件。  
- 生成安全启动公钥哈希文件。  
- 如果启用镜像加密，生成加密后的镜像文件。  

**输入**：描述文件（密钥描述文件、清单描述文件）、设备镜像、非对称密钥文件、可选扩展程序。  
**输出**：清单文件、公钥哈希文件、可选加密镜像文件。  

---

#### 安全启动核心（Secure boot core）

安全启动核心是运行在设备上的主要逻辑，实现以下功能：  
- 验证清单中的非对称公钥：制造阶段将公钥哈希写入 Fuse/OTP，只有当清单中的公钥哈希与之匹配时，才会继续验证流程。  
- 验证清单文件：清单由安全启动工具使用非对称私钥签名，签名和公钥一并保存于清单中。  
- 镜像解密：若启用了镜像加密，解密存储于设备非易失性存储器中的镜像。  
- 镜像验证：比对镜像摘要与清单内记录是否一致。  
- 扩展程序：验证并运行扩展程序，其验证同样由清单覆盖。  

安全启动核心以源码形式发布，并附带相关头文件，其中包含若干 API 函数。  

---

#### 清单文件（Manifest）

清单文件是描述安全启动配置的元数据，供安全启动核心使用。内容包括：  
- 清单标志（版本、安全启动使能标志等）。  
- 清单的签名和签名类型。  
- 用于验证清单签名的非对称公钥。  
- 设备镜像信息：镜像数量、加载地址、静态地址及加密标志。  
- 密钥块（Key blob，若启用镜像加密）：对称密钥标识。  
- 扩展程序（若有）。  

清单文件（Manifest）包含安全启动核心所需的全部信息。  
在制造阶段，需要将清单文件视为普通设备镜像，并烧录到设备的非易失性存储器（例如 Flash）中。

一个清单文件可以在安全启动验证过程中覆盖多个设备镜像。  
安全启动核心必须集成在 BootROM 中，作为制造阶段固化在只读存储器里的第一个启动镜像。  
为了减少资源占用，建议使用 **一个清单文件覆盖完整的启动路径**。 

---

#### 安全启动公钥哈希（Secure boot public key hash）

- 安全启动公钥哈希是安全启动核心中首先被验证的对象
- 制造阶段写入 Fuse/OTP，整个生命周期不可修改。  
- 启动核心通过计算清单中公钥的哈希值，与存储在 Fuse/OTP 中的哈希值对比，以验证公钥合法性。  

---

#### 镜像加密（Image encryption）

镜像加密是安全启动的增强功能：  
- 原始镜像由安全启动工具根据清单描述文件进行加密，加密密钥和 IV（CTR 模式下）由密钥描述文件提供。  
- 加密密钥由 TrustEngine-200 的密钥梯（Key ladder）生成。  
- 支持的算法：AES-ECB、AES-CTR。  
- 加密后，镜像存储于设备非易失性存储器；启动时，核心将其从静态地址读取、解密并复制到加载地址。  
- 若启用加密，镜像静态地址与加载地址必须不同，否则清单生成时会报错。  

---

#### 扩展程序（Extended program）

扩展程序允许在安全启动核心中运行用户代码，用于修复不可更改的代码（如 BootROM）。  
- 其验证由清单覆盖，运行在镜像验证完成后。  
- 建议逻辑尽量简单（如寄存器配置），避免复杂栈逻辑导致风险。  
- 扩展程序复用安全启动核心的执行环境，需要避免冲突（如栈溢出）。  

---

### 2.2.3 配置（Configurations）

安全启动的配置文件：  
`BootROM/sec_boot/secureboot/secure_boot_core/src/secure_boot_config.h`  

支持通过配置：  
- 精细化启用所需的加密算法。  
- 减少内存开销，同时满足安全需求。  

相关章节：  
- **3.2.4 Secure boot HAL/PAL > Configurations**  
- **3.9 TrustEngine-200 lite driver > Configurations**

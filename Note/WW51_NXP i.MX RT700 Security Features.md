## 19.2 功能描述

### 19.2.1 信任根 (RoT)

信任根 (RoT) 由真正的不可变硬件逻辑组成，包括模拟和数字逻辑、只读存储器 (ROM) 和一次性可编程 (OTP) 存储器。不可变 RoT 对于保证包括安全启动 (Secure Boot)、安全调试 (Secure Debug)、生命周期管理 (Life-cycle Management) 等在内的任何安全特性都至关重要。在本器件中，不可变 RoT 嵌入在 Boot ROM（不可变引导加载程序）中，并利用器件的硬件加密功能来实现其功能。

### 19.2.2 生命周期管理

在其使用寿命期间，典型的器件会经历多个阶段：从半导体工厂制造，到硅片制造商设施中的测试和封装，销售给分销商，再销售给原始设备制造商 (OEM)，由合同制造商组装、测试和预置 (provisioned)，最后交付给最终客户。若发生故障，器件可能会被退回 OEM 甚至硅片制造商进行故障分析。

**生命周期状态**用于反映器件的实际状态，进而指导器件在特定时间点如何保护其托管的资产。例如，当器件在硅片制造商处进行测试且尚未预置 OEM 或最终客户资产时，其调试或测试访问权限比在最终客户手中时更为宽松。

- **单调性：** 生命周期状态是单调的，即只能增加（向前推进）。
- **不可逆性：** 不同生命周期状态之间的转换是不可逆过程。
- **执行者：** 不可变 RoT 负责生命周期管理，并据此强制执行器件访问策略。

### 19.2.3 安全启动 (Secure Boot)

安全启动可确保器件引导加载程序、固件和其他软件在启动过程中的真实性 (authenticity)、完整性 (integrity) 和保密性 (confidentiality)，并确保器件进入预期的安全生命周期状态。

- **算法：** 使用 ECDSA P-256 配合 SHA-256，或 ECDSA P-384 配合 SHA-384 来保证固件镜像的真实性和完整性。
- **执行：** 不可变 RoT 根据生命周期状态定义的策略强制执行安全启动。

### 19.2.4 安全更新 (Secure Update)

安全更新是在现场安全地更新固件镜像的过程。

- **支持格式：** 本芯片的 ROM 支持使用 SB3.1 文件格式进行安全更新。
- **加密与签名：** SB3.1 文件使用 AES-128 或 AES-256 加密，并使用 ECDSA P-256 或 ECDSA P-384 签名。
- **功能：** 提供新镜像的真实性和保密性，并支持镜像防回滚 (rollback protection) 保护。

### 19.2.5 安全调试 (Secure Debug)

安全调试是遵循生命周期状态定义的策略来安全访问调试功能的过程。详情请参阅《安全参考手册》。

### 19.2.6 IP 保护

IP 保护是一套用于保护存储在器件上的高价值代码和数据之保密性和完整性的机制。

- **存储器加密：** 可使用基于 PRINCE 算法的存储器加密为存储在外部 Flash 中的代码/数据提供保密性。
- **支持区域：** XSPI0 和 XSPI1 最多支持 16 个独立的存储器区域/上下文。

### 19.2.7 安全隔离

该芯片具有多个功能域和电源域，其总线架构根据目标应用在最佳性能和功耗效率之间进行了平衡分区。芯片使用以下组件提供安全隔离：

- **ELS (EdgeLock Secure subsystem)：** 配备专用处理引擎和加密加速器，提供完全隔离的安全功能。
- **ARM TrustZone：** 基于 Armv8-M 架构提供额外的隔离：
  - **MPU (存储器保护单元)：** 位于 Cortex-M33 内核内部。CPU0 和 CPU1 各有 8 个 MPU 区域。
  - **SAU (安全属性单元)：** 位于 Cortex-M33 内核内部。CPU0 和 CPU1 各有 8 个 SAU 区域。
- **AHBSC (安全 AHB 总线控制器)：** 提供寄存器以定义哪些域可以访问共享 SRAM 以及存在于通用域和感知域中的外设。详情请参阅《安全参考手册》。

### 19.2.8 安全认证 (Secure Attestation)

安全认证是一套机制，用于向远程方提供关于器件真实身份、软件和固件版本以及其完整性和生命周期状态的证据。

- **RTF (Runtime Fingerprint)：** NXP 专有的认证机制，可测量器件在启动时和运行时的状态。

### 19.2.9 安全存储

本芯片支持具有以下两种密钥层级的 ELS 密钥存储 (Key store)：

1. **SRAM-PUF 生成的设备唯一密钥 (DUK)**
2. **基于 OTP 的 DUK**

_注意：仅在有外部非易失性存储器可用时，才支持 SRAM-PUF 生成的 DUK。_

> **NOTE:**
>
> - **SRAM-PUF 场景：** 若 ELS 密钥存储由基于 SRAM-PUF 的设备唯一密钥生成，则使用 **IPED (Inline Prince Encryption and Decryption engine)** 对片外 Flash 进行加解密。可针对代码存储和数据按区域选择普通计数器模式 (CTR) 或伽罗瓦计数器模式 (GCM)。
> - **OTP 场景：** 在基于 OTP 的 DUK 层级中，DUK 源自 OTP 种子和 ELS 命令。该密钥随后用于派生存储器加密 (PRINCE) 密钥。

### 19.2.10 信任预置 (Trust Provisioning)

信任预置是创建初始设备身份密钥的过程。其主要目标是提供器件来源的加密证明，并为 OEM 提供一套工具以安全地预置其自有资产。

- **流程：** 每个器件上都会创建一个设备唯一的公私钥对，公钥部分由 NXP 收集并签名。
- **证书：** 签名后的公钥以设备唯一证书的形式安装回每个器件，作为器件来源的实际证明。
- **应用：** 对应的私钥与其他预装密钥一起用于认证和建立与器件的安全连接，从而实现 OEM 资产的安全预置。

### 19.2.11 安全密钥管理

安全密钥管理是保护高价值密钥及各种密钥材料的过程，这对于维护最终用户、OEM 和 NXP 资产的安全至关重要。

- **依赖基础：** 该过程强烈依赖于由 ELS 密钥存储、硬件逻辑和 ROM 组成的不可变 RoT。
- **密钥派生：** 提供一个设备唯一的主密钥 (Master Key)，仅用于进一步的密钥派生。部分派生数据由不可变 RoT 提供，准确反映器件状态，确保在不同状态下派生出不同的密钥。
  - _示例：_ 不同的生命周期状态通常会产生不同的派生密钥。同样，调试端口打开时派生的密钥与关闭时不同。
- **安全性：** 所有平台密钥都驻留在安全子系统内，始终对应用内核不可见。

### 19.2.12 异常检测与反应

异常检测与反应描述了分析器件输入输出（如传感器数据）以及软件完整性和应用运行是否存在异常事件的过程或算法。如果需要，该机制将触发并执行用户定义的安全应用程序（例如：记录异常、向云端后台发送消息、复位器件以及更改生命周期状态）。

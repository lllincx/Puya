TrustEngine一般应用在类似ARM TrustZone的安全感知系统。
TrustZone在概念上将SoC的硬件和软件资源划分为安全(Secure World)和非安全(Normal World)两个世界，所有需要保密的操作在安全世界执行（如指纹识别、密码处理、数据加解密、安全认证等），其余操作在非安全世界执行（如用户操作系统、各种应用程序等）。处理器架构上，TrustZone将每个物理核虚拟为两个核，一个非安全核（Non-secure Core, NS Core），运行非安全世界的代码；和另一个安全核（Secure Core），运行安全世界的代码。非安全核只能看到非安全世界的系统资源。而安全核可以看到所有的系统资源。

TrustEngine 主要包括哈希，对称加密，非对称加密，真随机数生成器，随机数池，OTP 空间接口，生命周期控制器等单元。子模块可以通过 APB 总线配置，哈希，SCA 模块数据通过 AHB 总线传输，ACA 子模块有一块内置的 SRAM。

IP 的 feature list 如下：
支持国密的 SM234 以及国际的 rsa，sha，aes 等标准

---

TrustEngine 的对称性加密模块主要有三种命令：初始化，处理和结束。初始化命令可以附加密钥和初始向量参数。处理命令需要源地址，目标地址，数据长度参数。结束命令没有参数。左侧展示了在一组 SCA 命令中需要写入入口寄存器的数据或者命令信息

这一部分主要介绍 SCA 命令的共同部分，包括操作码，模式，中断模式
其中初始化，处理和结束命令操作码分别为 80，40，20

在共同部分之外，SCA 的初始化命令还包含了密钥和初始向量配置参数
初始向量参数包括是否需要初始向量，和初始向量格式为地址或立即数。
密钥参数包括密钥来源，主要分为外部密钥和内部密钥，如果是内部密钥，则需要附加 EK1，EK2，EK3 参数作为密钥梯 key ladder。
EK2，EK3 和初始向量的长度都固定为 128 位。密钥长度参数控制的是 EK1 与外部密钥的长度，不同的 SCA 模式和算法标准支持的长度不同，为了便于理解，我整理了一个表格
支持的算法标准有 AES 和 SM4，SCA 格式包括 ECB，CTG 等。

这里展示了一组 SCA 命令，在初始化命令之前打开中断屏蔽，使能 SCA 模块。
初始化命令指定密钥来源是内部，这代表需要输入密钥梯。指定密钥长度是 128 位。算法编制是 SM4，密钥格式是立即数。不加载初始向量。开启中断。随后向队列寄存器写入三个 128 位的 EK123.
处理命令配置为加密模式，开启中断。随后向队列寄存器写入源地址，数据长度 200，目标地址。
最后写入结束命令，开启中断。

后面两页是文档里对 SCA 寄存器的描述

---

哈希模块的命令与 SCA 基本相同，区别在于初始化的参数是初始向量及其长度，目标地址从每个处理命令后移到结束命令之后。

哈希命令共同部分也与SCA基本一致

哈希的初始化命令中主要配置了初始参数和哈希模式。初始向量源为0则采用算法默认向量，不必附加初始向量 。长度为0则不必附加长度参数。格式指定了初始向量为立即数或地址。

IP支持的哈希模式有SHA1、224、256和国标的SM3，这里列出了这四种模式的优缺点。

哈希处理命令支持配置大小端，结束命令支持配置是否执行哈希补全。

实例中哈希初始化命令指定哈希模式为SHA-256，初始向量来源为默认值，长度为零，因此初始化命令不需要附加参数。开启中断。哈希控制寄存器写1，开始运行。
哈希处理命令指定小端传输，开启中断。之后向队列寄存器写入源地址和数据长度。控制寄存器写1，开始运行。
哈希结束命令配置支持哈希补全，开启中断。之后向队列寄存器写入目标地址。控制寄存器写1，开始运行。

---

IP支持加速非对称密码功能，包括非对称加解密，数字签名与验证，密钥交换等

非对称加密的控制命令相对更加复杂，主要可以分为操作码和四个操作数。操作码指定了多种逻辑微操作类型，主要分为基本算数运算，逻辑运算和模运算

\***

实例中首先运行通用寄存器配置函数，再将待处理数据存入SRAM，将期待数据长度存入长度通用寄存器0之后执行ACA命令。
指定操作码为0x10，指定长度类型寄存器为0，操作数abcr分别指向通用寄存器0123，开启中断。
操作配置寄存器写1，开始执行。

---

OTP空间存储了安全感知系统的各种敏感信息，IP定义了四种生命周期LCS来表示产品的不同阶段
主要分为CM，DM芯片器件制造阶段，DD设备部署阶段和DR设备撤销阶段。
芯片、器件制造 阶段，芯片处于生产过程中，可使用芯片接口和外部测试功能。  
在这个阶段中，需要完成所有 OEM 信息配置工作（包括设备 ID、密钥、型号ID密钥等）。
芯片制造和设备制造的区别在于芯片制造（扫描链，mbist），但在 OTP 数据读写权限方面无区别。
设备部署阶段，设备处于正常状态。启用安全功能。禁止写入 IP 定义的 OTP 区域。
设备撤销 阶段，芯片被送回制造商进行故障分析。此时用户定义的安全数据必须清除。

表格展示了OTP空间内的各种数据以及在正常模式和安全模式下的读写权限。
由于我们的读写框架不兼容通过IP进行写入，因此只需要关注红色部分，在设备部署和撤销阶段的密钥信息是无法读取的。

这部分介绍通过改变flash数据修改lcs的方法，IP内部存在参数设置OTP空间的初始值，这里实际为1。在这种情况下，实际载入到OTP空间的数据是flash里数据按位取反。因此，为了将LCS配置为CM、DM、DD、DR，flash里面lcs相关的数值应该设置为7、6、4、0。

这部分再简单介绍一下，正常情况下OTP空间的写入方式。
在OTP_WR_ADDR 和 OTP_WR_DATA分别写入准备写入的地址和数据，然后OTP_WR写1开始运行。
这个功能在我们的应用中是无法使用的。

---

真随机数生成器TRNG的基本思想是使用低频时钟对快速切换信号进行采样。快速切换信号由熵源提供，可以选择内外熵源，内部熵源由环形振荡器产生。
采样模块使用同步电路进行采样。
后处理模块可以对生成的真随机数进行工艺变化补偿等随机性改进措施，IP可选的后处理方法有VN，CRNG，PRNG三种方法。
评估测试模块依据标准对数据进行复杂检查，可以选择自相关测试，重复计数测试，自适应比例测试，可自定阈值并向主机提供反馈，从而确定是否重新生成随机数。最后将数据存入随机数池。
# 52.1 特性

- Armv8-M TrustZone 安全技术
  - 实现了 IDAU (实现定义的属性单元)
  - 实现了 SAU (安全属性单元)
    - 8 个区域
  - 实现了 MSAU (主安全属性单元，即用于 CPU 以外主设备的 IDAU)
  - Code MRAM (代码 MRAM)
    - 最多 2 个区域 (安全/非安全)
  - SiP flash (仅限 SiP 产品)
    - 最多 2 个区域 (安全/非安全)
  - CM33 TCM
    - C-TCM 和 S-TCM 各最多 2 个区域 (安全/非安全)
  - SRAM
    - 每个 SRAM 最多 2 个区域 (安全/非安全)
  - VBATT 备份寄存器
    - 最多 2 个区域 (安全/非安全)
  - 外设 (Peripheral)
    - 可为每个单元/通道单独设置安全属性
  - CSC (\*1)：CSC 区域定义为非安全
  - SDRAM (\*1)：SDRAM 区域定义为非安全
  - OPSI0 (\*1)：OPSI0 区域定义为非安全
  - OPSI1 (\*1，仅限标准产品)：OPSI1 区域定义为非安全
- 特权控制 (Privileged control)
  - 除 VBATT 备份寄存器外，存储器的访问权限由特权代码管理的 MPU 控制
  - VBATT 备份寄存器的特权属性由各控制器的寄存器控制
  - 每个外设可单独配置特权或非特权属性
- 设备生命周期管理
- 三种调试级别
  - AL2：启用非安全和安全调试功能，且调试器均可访问
  - AL1：仅启用非安全调试功能，调试器仅可访问定义的非安全调试可访问区域
  - AL0：无可用调试功能
- 密钥注入
- 安全工厂烧录
  - 支持在不可信工厂环境中以密文格式进行镜像烧录
- 安全启动 (Secure boot)
  - 支持在 OTP 中存储最多四个可撤销的信任根 (RoT)，其形式为 RoT 公钥的 SHA-256 哈希摘要。
  - 验证待烧录镜像的完整性和真实性。
  - 在执行镜像之前，通过不可变（OTP）的第一阶段引导加载程序 (FSBL) 验证可执行镜像的完整性和真实性。
- 加密加速器
  - 参见第 53 节，瑞萨安全 IP (RSIP-E50D)。
- 安全引脚复用
  - 所有 I/O 端口引脚均可单独配置为安全或非安全
  - 仅当外设和 I/O 端口的安全属性匹配时，外设引脚功能才有效。
- 实时解密 (Decryption on the fly)
  - 实时解密 (DOTF) 可实时解密存储在外部存储器中的加密内容。

> 注 1：外部 RAM 和外部设备区域中不存在 TrustZone 过滤器。因此，即使在 SAU 设置中将这些区域标记为安全，除 CPU 以外的非安全主设备仍可访问它们。

# 52.2 篡改检测 (Tamper Detection)

该器件配备了能够检测外部篡改尝试的 I/O 端口。在发生篡改事件时：

- 时间戳：RTC 可以记录事件发生的时间戳，并可产生中断。
- 硬件唯一密钥 (HUK)：检测到篡改事件后，HUK 将被清零。
- VBATT 备份寄存器：检测到篡改事件后，VBATT 备份寄存器将被清零。

# 52.3 Arm 安全特性 (Arm Security Features)

## 52.3.1 Arm TrustZone 技术

Arm TrustZone 技术将系统和应用划分为安全域和非安全域。

- 安全应用可以发起安全事务和非安全事务
- 非安全应用只能发起非安全事务
- 安全事务只能访问安全存储器和资源
- 安全事务只能使用安全区域地址发起
- 非安全事务只能访问非安全存储器和资源
- 非安全事务只能使用非安全区域地址发起。
  ![image.png|500](https://lincx-img.oss-cn-shanghai.aliyuncs.com/img/20251201145836648.png)

## 52.3.2 特权控制 (Privileged Control)

系统和应用分为特权域和非特权域。CPU 可通过以特权或非特权模式执行代码来限制或排除对某些资源的访问

- 特权模式可以访问特权和非特权域
- 非特权模式只能访问非特权域

## 52.3.3 安全属性 (Security Attribution)

Armv8-M 的 TrustZone 实现由安全属性单元 (SAU) 和实现定义属性单元 (IDAU) 组成。4GB 存储空间被划分为安全 (S) 和非安全 (NS) 存储区域。安全存储空间进一步分为两种类型：非安全可调用 (NSC) 和安全 (Secure)。

- S (Secure | 安全)： 安全地址，用于仅允许安全软件或安全主设备 (Secure Masters) 访问的存储器和外设。
- NSC (Non-Secure Callable | 非安全可调用)： 一种特殊的安全区域。这是 Armv8-M 处理器唯一允许存放 安全网关 (SG) 指令的存储器类型，该指令用于使软件从非安全状态切换到安全状态。
- NS (Non-secure | 非安全)： 非安全地址，用于可被设备上运行的所有软件访问的存储器和外设。

### 52.3.3.1 实现定义属性单元 (IDAU)

IDAU 通过地址位 [28] 将代码、SRAM 和外设区域定义为安全别名区域和非安全别名区域。安全代码区域和安全 SRAM 区域被分配了 NSC 安全属性。由 IDAU 定义的安全映射固定在硬件中，无法通过软件更改。

### 52.3.3.2 主安全属性单元 (MSAU)

MSAU 是用于定义除 CPU 以外的主设备 (Master) 的系统特定安全地址映射的 IDAU。MSAU 定义了安全和非安全别名区域，但不定义非安全可调用 (NSC) 和区域编号。除 CPU 以外的主设备可以使用由 MSAU 定义的安全别名地址来发起安全事务。但是，禁止非安全主设备利用安全别名区域中的地址来发起安全事务。由 MSAU 定义的安全映射固定在硬件中，无法通过软件更改。
![image.png|600](https://lincx-img.oss-cn-shanghai.aliyuncs.com/img/20251201150706866.png)

### 52.3.3.3 安全属性单元 (SAU)

SAU 是一个用于确定地址安全属性的可编程单元。SAU 仅可在安全状态下进行编程，并具有类似于 MPU 的程序员模型。如果一个地址同时映射到了由 IDAU 和 SAU 定义的区域，系统将选择安全级别最高的区域。安全主设备可以使用各个安全别名区域的地址来发起安全事务和非安全事务。非安全主设备无法使用安全别名区域的地址发起安全事务。

地址映射安全级别的最终判定 (SAU 设置规则): 在使用 TrustZone 进行安全和非安全区域隔离时，必须按照以下规则设置 SAU：

1. IDAU 中设置为 NS (非安全) 属性的区域，在 SAU 中也必须设置为 NS。
2. 在 IDAU 定义为 NSC 的任何区域内，必须至少创建一个 NSC 区域。
3. 如果不想使用 TrustZone 定义任何隔离，请不要更改 `SAU_CTRL.ALLNS = 0` 和 `SAU_CTRL.ENABLE = 0`（初始值）。
   ![image.png|600](https://lincx-img.oss-cn-shanghai.aliyuncs.com/img/20251201150813609.png)
   ![image.png|600](https://lincx-img.oss-cn-shanghai.aliyuncs.com/img/20251201150858539.png)

### 52.3.3.4 区域编号 (Region Number)

SAU 和 IDAU 还为每个存储区域和安全属性定义了区域编号。软件使用该区域编号来确定连续的内存范围是否共享相同的安全属性。

![image.png|300](https://lincx-img.oss-cn-shanghai.aliyuncs.com/img/20251201154226001.png)

### 52.3.3.5 TrustZone 过滤器的存储器安全属性

存储器被划分为 S 和 NS 区域。

**Code MRAM 和 SiP Flash**

- 其安全属性是在设备生命周期处于 OEM 状态且认证级别为 AL2 时，通过引导固件命令存储到非易失性存储器中的。这些属性在应用执行前生效。应用程序无法更新它们，但可以通过寄存器读取。
- 最多可划分为 2 个区域。
- SiP Flash 的编程或擦除应由安全用户管理，以防止非安全用户对安全区域进行操作。

**CM33 TCM, SRAM, VBATT**

- 安全属性由专用的安全属性寄存器设置，仅允许通过安全访问写入。
- 最多可划分为两个区域。

![image.png|400](https://lincx-img.oss-cn-shanghai.aliyuncs.com/img/20251201155743028.png)

### 52.3.3.6 CPU 安全属性

仅当 Cortex-M33 被配置为双核产品中的从 CPU (secondary CPU) 时，才可以通过引导固件命令禁用 Cortex-M33 安全扩展。这是一个永久性设置。

### 52.3.3.7 TrustZone 过滤器的外设安全与特权属性

每个外设均可配置为安全或非安全，以及特权或非特权。

- **Type1 外设**：具有单一的安全和特权属性，控制所有寄存器的访问。
- **Type2 外设**：针对每个寄存器或每个位具有独立的安全和特权属性。

## 52.3.4 TrustZone 访问错误

| **主设备**        | **行为**                                                               |
| ----------------- | ---------------------------------------------------------------------- |
| **DAP**           | 仅返回错误响应                                                         |
| **CPU**           | IDAU/SAU 检测到 SecureFault 异常；TrustZone 过滤器检测到 BusFault 异常 |
| **DMAC/DTC**      | 发出 IRQ 或复位；停止传输；生成中断 (DMAn_TRANSERR)                    |
| **ESWM/MIPI-CSI** | 发出 IRQ 或复位；生成中断 (ETHER_GWEI/VIN_IRQ)                         |
| **DRW/MIPI-DSI**  | 停止下一次传输；发出 IRQ 或复位；生成中断                              |
| **NPU/GLCDC/CEU** | 发出 IRQ 或复位                                                        |

## 52.4 器件生命周期管理

器件生命周期管理（DLM）用于识别器件当前的开发、生产或部署阶段，并控制调试功能、串行编程接口以及 Renesas 测试模式的能力。

| **生命周期状态 (Lifecycle)** | **定义 (Definition)**                               | **保护级别 (Protection level)** | **调试功能 (Debug function)** | **串行编程 (Serial programming)**            | **瑞萨测试模式 (Renesas test mode)** |
| ---------------------------- | --------------------------------------------------- | ------------------------------- | ----------------------------- | -------------------------------------------- | ------------------------------------ |
| **OEM**                      | **原始设备制造商**                                  | PL2 或 PL1 或 PL0               | 取决于认证级别                | 取决于认证级别                               | 不可用                               |
| **LCK_BOOT**                 | 锁定启动接口。调试接口和串行编程接口被永久禁用。    | PL0                             | 不可用                        | 不可用                                       | 不可用                               |
| **RMA_REQ**                  | 退料授权请求。 客户必须在此状态下将设备发送给瑞萨。 | PL0                             | 不可用                        | 可用<br>_(无法访问代码 MRAM/SiP Flash 区域)_ | 不可用                               |
| **RMA_ACK**                  | 退料授权已确认 。瑞萨进行故障分析。                 | PL2                             | 在安全和非安全调试中可用      | 可用<br>_(无法访问代码 MRAM/SiP Flash 区域)_ | 可用                                 |
| **RMA_RET**                  | 退料授权返回. <br>设备已返回给客户。设备无法启动。  | PL0                             | 不可用                        | 不可用                                       | 不可用                               |

![image.png|600](https://lincx-img.oss-cn-shanghai.aliyuncs.com/img/20251201162432665.png)

## 52.4.1 更改生命周期状态 (Changing the Lifecycle State)

使用引导固件命令 (boot firmware commands) 来更改设备生命周期状态。
生命周期状态无法通过应用程序更新，但可以通过 `DLMMON` 寄存器读取当前的生命周期状态。
每次状态转换都是单向的，状态不可回退 (regressed)

### 分支一：产品部署路径 (OEM $\rightarrow$ LCK_BOOT)

- 在 AL2 或 AL1 中使用参数设置命令可**禁止**转换到 LCK_BOOT
- 调试接口和串行编程接口永久禁用

### 分支二：故障分析路径 (RMA 流程)

这是当芯片出现问题，需要寄回瑞萨（Renesas）进行分析时的流程。这是一个多阶段的单向链条。

**第一步：OEM 发起退料授权请求 (OEM $\rightarrow$ RMA_REQ)**

- **转换前提**：需要使用 **RMA_KEY** 进行密钥认证，该密钥必须由客户在 AL2 状态下预先注入。RMA_KEY 的密钥长度为 128 位。
- **内容擦除**：转换到 RMA_REQ 状态时，除以下内容外， MRAM 和 SiP Flash 中内容将被擦除。（在故障分析时，Renesas 可以读取永久锁定的块或寄存器的内容)。
  - 通过配置 `PBPS`/`PBPS_SEC` 寄存器永久锁定的 MRAM 块。
  - 通过配置 `POFSPS` 寄存器永久锁定的选项设置存储器。
- **禁用方法**：如果 **AL2_KEY** 被禁用，则无法转换到 RMA_REQ。
- **生效方法**：将器件生命周期状态更改为 RMA_REQ 后，MCU 不会立即响应。要继续使用启动固件命令，必须在复位后再次进入启动模式.

**第二步：瑞萨接收与分析 (RMA_REQ $\rightarrow$ RMA_ACK)**

- **转换前提**：需要瑞萨专用的密钥 (`RMA_ACK_KEY`) 进行认证。
- （安全和非安全）调试功能开启，进行故障分析。

**第三步：退回 OEM (RMA_ACK $\rightarrow$ RMA_RET)**
设备被寄回给 OEM。设备无法启动，生命周期结束。

### 密钥认证方法

密钥认证采用“质询与响应” (Challenge and Response) 认证方式，或使用 MCU 唯一 ID 进行认证。响应值（用于质询与响应认证）或认证码（使用 MCU 唯一 ID）的计算方法如下：

$$\text{Response} = \text{AES-128 CMAC} (\text{RMA\_KEY}, \text{128-bit challenge})$$
$$\text{Authentication code} = \text{AES-128 CMAC} (\text{RMA\_KEY}, \text{128-bit MCU unique ID})$$

## 52.4.2 保护级别和认证级别 (Protection and Authentication Level)

- 保护等级 (PL) 和认证等级 (AL) 决定了调试功能和串行编程接口的可用性。
- 仅 OEM 生命周期状态下，才可以更改 PL 和 AL。
- AL 表示一种临时的认证状态，并在 MCU 上电复位后初始化为 PL。PL 和 AL 仅能由启动固件 (Boot Firmware) 修改，应用程序无法对其进行更改。
  ![image.png|600](https://lincx-img.oss-cn-shanghai.aliyuncs.com/img/20251203103630337.png)

| **认证级别 (AL)** | **调试功能**                                                       | **串行编程接口**                                                        |
| ----------------- | ------------------------------------------------------------------ | ----------------------------------------------------------------------- |
| **AL2**           | 非安全和安全调试功能均已启用，且调试器可访问。                     | 所有功能均可用。                                                        |
| **AL1**           | 仅启用非安全调试功能，调试器仅可访问定义的“非安全调试可访问区域”。 | 可用，但**无法**对安全代码 MRAM 或 SiP Flash 区域进行编程、擦除或读取。 |
| **AL0**           | 无可用调试功能。                                                   | 可用，但**无法**访问代码 MRAM 或 SiP Flash 区域。                       |

### 修改保护等级 (PL)

- 降级：无任何限制。
- 升级：要求 MCU 当前必须处于与目标 PL 对应的 AL 等级。例如：若当前处于 AL1，则可设为 PL1，但无法设为 PL2。
- 初始化：重置 PL，恢复为 PL2，同时 MRAM 和 SiP Flash 中的内容将被擦除。

### 修改认证登记（AL）

- 降级：无任何限制。
- 升级：使用相应的 `AL2_KEY` 或 `AL1_KEY` 进行密钥认证。

初始化命令条件：选项设置存储器的 OTP 区域空，且 AL2_KEY 未禁用。
执行初始化命令后 MCU 不再响应。要继续使用串行编程命令，请在复位后重新进入 Boot 模式。

密钥（128 位）：
AL2_KEY：仅可在 AL2 状态下注入或禁用。
AL1_KEY：可在 AL2 或 AL1 状态下注入或禁用。

## 52.4.3 串行编程 (Serial Programming)

串行编程器是否可以连接以及可访问的内存范围取决于设备生命周期状态和 AL。此外，接受的串行编程命令也因设备生命周期状态和 AL 而异。

## 52.4.4 设备生命周期状态和 PL 更改示例

本节描述了一个典型的设备生命周期状态和 PL 更改流程示例。

1. **安全开发者 (Secure developer)**

   - 使用引导固件命令设置代码 MRAM 和 SiP Flash 的存储器安全属性。
   - 编程并调试安全应用程序。
   - 如果需要 `AL2_KEY` 和 `RMA_KEY`，使用引导固件命令注入它们。
   - 注入表 52.8 中列出的应用层 AES、ChaCha20-Poly1305、RSA、ECC、HMAC 和 EdDSA 密钥（如需）。
   - **为非安全开发者做准备**：
     - 如果不允许非安全开发者使用 Initialize 命令，使用引导固件命令将其禁用。
     - 如果不使用 `AL2_KEY` 且不允许非安全开发者使用 Initialize 功能，使用引导固件命令禁用 `AL2_KEY`。
     - 使用引导固件命令将 PL 从 **PL2 更改为 PL1**。

2. **非安全开发者 (Non-secure developer)**

   - 编程并调试非安全应用程序。
   - 如果需要 `AL1_KEY`，使用引导固件命令注入它。
   - 注入表 52.8 中列出的应用层 AES、ChaCha20-Poly1305、RSA、ECC、HMAC 和 EdDSA 密钥（如需）。
   - **为最终产品部署做准备**：
     - 使用引导固件命令禁用 Initialize 命令（如需）。
     - 如果不使用 `AL1_KEY`，使用引导固件命令禁用 `AL1_KEY`。
     - 使用引导固件命令将 PL 从 **PL1 更改为 PL0**。

## 52.4.5 故障分析 (Failure Analysis)

如果客户请求瑞萨进行故障分析，必须先将设备生命周期状态更改为 **RMA_REQ** 后再发送设备。如果设备不在 RMA_REQ 状态，瑞萨无法执行故障分析。故障分析完成后，瑞萨会将生命周期更改为 **RMA_RET** 并将设备退还给客户。

> **注**：将设备生命周期状态更改为 RMA_REQ 需要 `RMA_KEY`，或者必须使用 MCU 的唯一 ID 作为认证代码的一部分。详情请参见 52.4.1 节“更改生命周期状态”。

# 52.5 安全密钥注入 (Secure Key Injection)

要将用户密钥注入 MCU，请执行以下步骤。瑞萨在官网提供了**安全密钥管理工具 (Security Key Management Tool)** 以辅助密钥注入的准备工作。

1. 创建一个 256 位的安装密钥 (Installation key)：此密钥称为**用户工厂编程密钥 (UFPK)**，用于封装 (wrap) 用户密钥。
2. 通过瑞萨密钥封装服务 (Renesas Key Wrapping Service) 获取 UFPK 的封装版本 (**W-UFPK**)。
3. 使用 UFPK 对用户密钥进行封装。
4. 使用引导固件命令将 **W-UFPK** 和**封装后的用户密钥**发送到 MCU。

MCU 内部会解封用户密钥，并使用 MCU 的**硬件唯一密钥 (HUK)** 重新封装，然后存储在非易失性存储器中。 DLM 密钥存储在未映射的 Flash 中。应用程序密钥存储在密钥注入命令指定的地址处。

图 52.9 展示了密钥注入的示例，表 52.8 展示了可注入的密钥。

![image.png|600](https://lincx-img.oss-cn-shanghai.aliyuncs.com/img/20251204135604147.png)

# 52.6 安全工厂编程 (Secure Factory Programming)

MCU 还支持对密文格式的固件镜像进行编程，以防止资产在生产编程期间泄露。这使得在非安全环境下的安全工厂编程成为可能。安全工厂编程由启动固件支持。与安全密钥注入类似，安全工厂编程具有类似的流程。
![image.png|600](https://lincx-img.oss-cn-shanghai.aliyuncs.com/img/20251204141548695.png)

1. 客户使用 UFPK 封装镜像加密密钥 (Image Encryption Key)
2. 使用镜像加密密钥通过 AES128-CCM 算法对镜像进行加密。
3. 当客户通过串行编程接口将 W-UFPK、已封装的镜像加密密钥和加密镜像发送到 MCU 时，MCU 会解密并编程固件镜像。

- 安全工厂编程可编程的最大容量接近 16 MB。
- DLM 状态、保护级别 (Protection Level) 和认证密钥 (Authentication Keys) 均可通过单个启动固件命令进行设置。

关于此启动固件命令的注意事项包括：

- 仅当 MCU 处于 **OEM 状态**时，才能执行加密固件编程。
- 该命令会更改 MCU 的保护级别。初始 PL 必须为 **PL2**。最终 PL 必须为 **PL0**。
- 如果 DLM 状态保持在 OEM 状态，则必须注入 **AL2 密钥**。也可以选择注入 AL1 密钥。
- MCU 可以转换为 **LCK_BOOT 状态**。在这种情况下，无法注入 AL 密钥。
- AL 密钥必须使用与镜像加密密钥相同的 **UFPK** 进行封装。
- 该命令在编程加密固件镜像之前，会擦除除选项设置存储器 (option-setting memory) 之外的所有代码 MRAM 区域。如果有任何永久锁定的块，则无法执行此命令。
- 当前的寄存器设置或写入与启动区域选择相关的寄存器的值需要为： `SAS.BTFLG = 1b`
- 所有选项设置存储器的值必须包含在加密固件镜像中，包括那些未更改默认值的设置。但是，如果【受 `POFSPS` 寄存器保护的配置设置区域】受写保护，则写入数据**不应**包含在镜像中。如果包含，此命令将因错误而终止。

# 52.7 安全启动 (Secure Boot)

安全启动旨在验证位于应用程序可执行存储器起始位置的 OEM 引导加载程序（称为 OEM_BL）的完整性和真实性。
OEM_BL 的验证发生在两个时间点：**初始编程时**以及**每次执行前**。

## 编程时的验证

当使用引导固件 (Boot Firmware) 编程`OEM_BL`时，系统会对其进行验证。此过程使用两份证书：

**密钥证书 (Key Certificate)**
认证对象：`OEM_BL`验证密钥（ `OEM_BL_PK`，即`OEM_BL` 验证密钥对的公钥）
签名：由`OEM_BL`验证根密钥对的私钥（ `OEM_ROOT_SK`）签名
`OEM_ROOT_PK`的哈希值（SHA2-256）通过"52.5 安全密钥注入”作为信任根密钥注册到 MCU 中。

**代码证书 (Code Certificate)**
认证对象：`OEM_BL`
签名：由`OEM_BL`验证密钥对的私钥部分（`OEM_BL_SK`）签名

**摘要编程**
`OEM_BL` 验证成功后，会生成 `OEM_BL` 和代码证书的 HMAC 值（称为`OEM_BL_digest`）并将其编程到 MRAM 中
HMAC 密钥派生自 **HUK (硬件唯一密钥)**，因此每个 MCU 生成的 HMAC 值都是独一无二的

![image.png|600](https://lincx-img.oss-cn-shanghai.aliyuncs.com/img/20251208111644655.png)

## 执行时的验证

在单芯片模式下，当 `FSBLCTRL0` 寄存器启用了 FSBL 时，复位后将执行片上 OTP 中的**不可变第一阶段引导加载程序 (FSBL)**。

验证逻辑由 `FSBLCTRL1` 寄存器配置：

- **Secure Boot 模式**：FSBL 生成 OEM_BL 和代码证书的 HMAC 值，并与预期的 HMAC 值进行比较。若一致，FSBL 跳转至 OEM_BL。
- **CRC Boot 模式**：FSBL 计算 OEM_BL 的 CRC 值，并与代码证书中的预期 CRC 值比较。若一致，FSBL 跳转至 OEM_BL。

## 代码证书地址管理

代码证书必须编程在 MRAM 中，其位置信息存储在 `SACC0n` 或 `SACC1n` 寄存器中：

- `SACC0n`：指定 `BTFLG = 1` 时的代码证书起始地址。
- `SACC1n`：指定 `BTFLG = 0` 时的代码证书起始地址。

SACC 寄存器 OTP（一次性可编程）且不可擦除，各有 4 个区域用于更新代码证书的起始地址。

- **读取规则**：FSBL 按 $n$ 值**从大到小**的顺序读取，使用第一个**非全 1** 的值作为有效地址。
- **写入规则**：因此，编程时应按 $n$ 值**从小到大**的顺序使用寄存器。

## 其他

**测量报告**
当在 FSBLCTRL1 寄存器中启用测量报告时，FSBL 将测量报告存储到 SAMR 寄存器指定的 SRAM 地址。读取测量报告时，通过设置 `SRAMCRn.ECCMOD[1:0] = 00b` 禁用 ECC 功能。

**FSBL 跳过**
根据 FSBLCTRL0 寄存器的配置，可以在软件复位或深度软件待机复位后跳过 FSBL 的执行。

**验证失败**
如果生成的 HMAC 或 CRC 值与预期值不同，则向 FSBLCTRL2 寄存器设置的端口输出高电平，MCU 进入 CPU 睡眠模式。

## OEM_BL 更新

OEM_BL 可以由应用程序代码更新。在这种情况下，应用程序代码必须验证更新后的引导加载程序，生成 OEM_BL_digest，并将其存储在紧随新代码证书之后的位置。

OEM_BL 的实现由用户定义且特定于应用程序。但是，建议在代码 MRAM 中实现状态标志，例如更新完成标志 (UCF) 和增量完成标志 (ICF)，以作为应对因意外电源故障导致更新错误的对策。如果发生更新错误，可以如图所示进行恢复。如果发生更新错误，FSBL 执行后将执行当前的 OEM_BL。注意，当前的 OEM_BL 和新的 OEM_BL 都需要更新错误判定程序。

# 53 瑞萨安全 IP（RSIP-E50D）

该安全引擎由一个隔离子系统构成，包含访问管理电路、存储区域、加解密电路以及随机数生成电路。
配合 RSIP 库，该安全引擎可防止窃听（维护保密性）、信息篡改（确保完整性）以及伪装（验证真实性）。
由于加解密所需的密钥信息仅存储在安全引擎内部，且所有来自外部的直接访问均可被阻断，该引擎有助于构建更鲁棒（Robust）的安全系统。

| **参数**                 | **规格**                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| ---------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **访问控制**               | **访问管理电路**<br>● 如果由于程序被篡改或 CPU 跑飞导致对安全引擎的异常访问，该电路将阻断所有后续访问并停止安全引擎的数据输出。同时产生中断 RSIP_TADI。                                                                                                                                                                                                                                                                                                                                                               |
| **对称密码算法**             | **AES**: 符合 NIST FIPS PUB 197 标准<br>● 密钥长度：128, 192 或 256 位<br>● 数据大小：128 位<br>● AES 支持以下分组密码模式：<br>  – ECB, CBC, CTR: 符合 NIST SP 800-38A<br>  – CCM: 符合 NIST SP 800-38C<br>  – GCM: 符合 NIST SP 800-38D<br>  – XTS: 符合 IEEE 1619-2007<br>● AES 支持以下认证算法：<br>  – CMAC: 符合 NIST SP 800-38B<br>  – GMAC: 符合 NIST SP 800-38D<br>**ChaCha20-Poly1305**: 符合 RFC7539 标准<br>● 密钥长度：256 位<br>● 分组大小：512 位<br>● 支持以下算法：<br>  – ChaCha20<br>  – ChaCha20-Poly1305 |
| **随机数生成**              | **128 位真随机数生成电路 (TRNG)**                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **非对称密码算法**            | **RSA**<br> ● 最大可操作位数：4224 位<br> ● 支持的密钥大小：1024 位, 2048 位, 3072 位 和 4096 位<br> ● 功能：签名生成、签名验证、公钥加密、私钥解密。<br>**ECC (椭圆曲线)**<br> ● 最大可操作位数：576 位<br> ● 支持的曲线：<br>   – NIST P-192, P-224, P-256, P-384, 和 P-521<br>   – Brainpool P256r1, P384r1, 和 P512r1<br>   – Ed25519<br>   – secp256k1<br> ● 功能：签名生成、签名验证、密钥生成。                                                                                                                                     |
| **消息摘要计算**             | **HASH (哈希)**<br> ● 分组大小：<br>   512 位 (SHA-224, SHA-256);1024 位 (SHA-512/224, SHA-512/256, SHA-384, SHA-512);1152 位 (SHA3-224), 1088 位 (SHA3-256), 832 位 (SHA3-384), 576 位 (SHA3-512), 1344 位 (SHAKE128), 1088 位 (SHAKE256)<br> ● 密钥大小：512 位或更少<br> ● HASH 支持以下安全哈希算法：<br>   – SHA-2 系列: 符合 FIPS PUB 180-4<br>   – SHA-3 系列及 SHAKE: 符合 FIPS PUB 202<br> ● HASH 支持以下消息认证算法：<br>   – HMAC: 符合 FIPS PUB 198                                               |
| **硬件唯一密钥 (HUK)**       | ● 一个只读的、256 位的硬件唯一密钥 (HUK)，仅可通过专用总线由安全引擎的访问管理电路访问。<br> ● 密钥派生函数 (KDF) 将 HUK 与密钥生成信息相结合。生成的派生密钥用于实现用户密钥的安全存储封装 (Key Wrapping)。<br> ● HUK 的唯一性防止了密钥被非法克隆或复制到该 MCU 系列的另一颗芯片上。<br> ● HUK 本身以封装 (加密，非明文) 格式存储在隔离的存储区域中，因此受到保护，防止非法访问和复制。                                                                                                                                                                                                                    |
| **应用密钥管理**             | ● 封装密钥 (Wrapped keys) 仅在安全引擎内部有效。                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **唯一 ID (Unique ID)**  | ● 一个只读的、128 位的 MCU 唯一 ID，可由访问管理电路访问。<br> ● 密钥派生函数 (KDF) 将 Unique ID 与密钥生成信息相结合。此类派生密钥用于在安全引擎边界内解封 (Unwrap) HUK。                                                                                                                                                                                                                                                                                                                                        |
| **OEM Boot Loader 版本** | ● 在成功验证固件更新后，安全引擎会输出当前的 OEM Boot Loader 版本 (OEM BL Ver.)。<br> ● MRAM 序列器支持使用 OEM Boot Loader 版本进行防回滚 (Anti-Rollback) 计数器保护，该版本可由安全引擎进行验证。                                                                                                                                                                                                                                                                                                              |
| **实时解密 (DOTF)**        | 安全引擎通过专用总线输出实时解密 IP (DOTF) 的密钥数据。DOTF0 和 DOTF1 的密钥可以单独设置。                                                                                                                                                                                                                                                                                                                                                                                              |
| **抗攻击能力**              | 具备针对侧信道攻击 (包括 SPA/DPA) 和时序攻击的应对措施。                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **模块停止功能**             | 可设置模块停止状态以降低功耗。                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **TrustZone 过滤器**      | 可设置安全 (Security) 和特权 (Privilege) 属性。                                                                                                                                                                                                                                                                                                                                                                                                                   |
